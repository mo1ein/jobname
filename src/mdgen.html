<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Jobname Markdown Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">

    <!-- Air Datepicker CSS (jsDelivr - v3.6.0) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/air-datepicker@3.6.0/air-datepicker.css">

    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Fira Sans', 'Ubuntu Mono', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, #f5f7fb 0%, #e4e8f0 100%);
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .container { display:flex; flex-direction:column; gap:20px; }

        .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        .full-width { grid-column: 1 / -1; }

        @media (max-width: 992px){ .form-grid { grid-template-columns: 1fr; } }

        header {
            text-align:center; margin-bottom:30px; padding:25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color:white; border-radius:12px; box-shadow:var(--shadow); position:relative; overflow:hidden;
        }
        header::before {
            content:""; position:absolute; top:-50%; left:-50%; width:200%; height:200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 60%);
            transform: rotate(30deg);
        }

        h1 { font-size:2.4rem; margin-bottom:10px; position:relative; font-weight:bold; }
        .description { font-size:1.1rem; opacity:0.9; max-width:700px; margin:0 auto; position:relative; }

        .card { background-color:var(--card-bg); border-radius:12px; box-shadow:var(--shadow); padding:20px; transition:transform .3s, box-shadow .3s; border:1px solid rgba(0,0,0,0.05); display:flex; flex-direction:column; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }

        .card-title { font-size:1.3rem; margin-bottom:15px; color:var(--primary); border-bottom:2px solid var(--primary); padding-bottom:8px; display:flex; align-items:center; gap:10px; }

        .form-group { margin-bottom:15px; }
        label { display:block; margin-bottom:8px; font-weight:600; color:var(--dark); display:flex; align-items:center; gap:8px; }

        input[type="text"], input[type="url"], input[type="date"], input[type="number"], input[type="time"], select, textarea {
            width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px; transition:all .3s; background-color:var(--light);
        }
        input:focus, select:focus, textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(67,97,238,0.2); background-color:#fff; }

        .checkbox-group, .radio-group { display:flex; flex-wrap:wrap; gap:10px; margin-top:8px; }
        .checkbox-label, .radio-label { display:flex; align-items:center; gap:8px; cursor:pointer; padding:10px 14px; background-color:var(--light); border-radius:8px; transition:all .3s; flex:1; min-width:120px; font-size:14px; }
        .checkbox-label:hover, .radio-label:hover { background-color:#e9ecef; transform:translateY(-2px); }

        input[type="checkbox"], input[type="radio"] { width:18px; height:18px; }

        .required { color:var(--warning); }

        button { padding:14px 24px; background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%); color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; transition:all .3s; display:inline-flex; align-items:center; justify-content:center; gap:10px; box-shadow:var(--shadow); }
        button:hover { transform:translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,0.15); }
        button.secondary { background:var(--light); color:var(--dark); border:1px solid var(--border); }
        button.secondary:hover { background:#e2e6ea; }

        .actions { display:flex; gap:15px; flex-wrap:wrap; margin-top:25px; justify-content:center; }

        .preview-container { width:100%; margin-top:20px; }
        .preview { white-space:pre-wrap; background-color:var(--light); padding:20px; border-radius:8px; border:1px solid var(--border); font-family:'Courier New', Courier, monospace; line-height:1.5; transition:all .3s; min-height:300px; max-height:500px; overflow-y:auto; font-size:14px; }
        .preview:hover { box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }

        .field-row { display:flex; gap:15px; }
        .field-row .form-group { flex:1; }

        .score-input { display:flex; align-items:center; gap:15px; }
        .score-input input { width:100px; flex-shrink:0; }
        .score-display { font-weight:bold; padding:8px 16px; border-radius:20px; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color:white; min-width:80px; text-align:center; }

        .toggle-section { margin-top:15px; }
        .toggle-header { display:flex; align-items:center; gap:10px; cursor:pointer; padding:10px; background-color:var(--light); border-radius:8px; transition:all .3s; font-size:14px; }
        .toggle-header:hover { background-color:#e9ecef; }
        .toggle-content { padding:15px; background-color:var(--light); border-radius:0 0 8px 8px; margin-top:-5px; border:1px solid var(--border); border-top:none; display:block; }

        .icon { font-size:18px; width:20px; text-align:center; }
        .success-badge { display:inline-block; padding:6px 12px; background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%); color:white; border-radius:20px; font-size:14px; margin-left:10px; }

        .time-inputs { display:flex; gap:15px; }
        .time-inputs .form-group { flex:1; }

        /* --- restore previous status / apply way layout --- */
        .status-options, .apply-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
        }

        /* Q&A editor styles */
        .qa-editor { display:flex; flex-direction:column; gap:12px; }

        .qa-controls { display:flex; justify-content:space-between; align-items:center; gap:12px; }

        .add-qa-btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; background:linear-gradient(135deg,#2b6cb0 0%,#2c5282 100%); color:white; border:none; cursor:pointer; font-weight:700; }

        .qa-list { display:flex; flex-direction:column; gap:12px; }

        /* make question and answer columns equal-height and the boxes equal size */
        .qa-item {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            align-items: stretch; /* ensure both Q + A match height */
        }

        .qa-item .question-input,
        .qa-item .answer-input {
            min-height: 120px;    /* same minimum height */
            resize: vertical;
            width: 100%;
            box-sizing: border-box;
        }

        .qa-item .qa-actions { display:flex; flex-direction:column; gap:8px; }
        .qa-item .remove-qa-btn { padding:8px 10px; border-radius:8px; background:#ffe6e6; border:1px solid #f5c2c2; color:#c62828; cursor:pointer; }
        .qa-item .move-qa-btn { padding:8px 10px; border-radius:8px; background:#e6f7e6; border:1px solid #cfe9cf; color:#2e7d32; cursor:pointer; }

        /* Small tweak for the date inputs when using Air Datepicker */
        .air-date-input { position:relative; }

        /* New styles for email fields */
        .email-field-group { display:flex; gap:15px; margin-bottom:15px; }
        .email-field-group .form-group { flex:1; position:relative; }
        .email-field-group .form-group::after {
            content: "OR"; position:absolute; top:50%; right:-25px; transform:translateY(-50%);
            background:var(--light); padding:5px 10px; border-radius:20px; font-size:12px; font-weight:bold; color:var(--gray); z-index:1;
        }
        .email-field-group .form-group:last-child::after { display:none; }

        .email-status-label { display:inline-block; padding:4px 8px; border-radius:4px; font-size:12px; margin-left:5px; }
        .rejection-status { background-color:#ffe6e6; color:#d32f2f; }
        .offer-status { background-color:#e6f7e6; color:#2e7d32; }
    </style>
</head>
<body>
    <div id="notification" class="notification" style="position:fixed; top:20px; right:20px; padding:15px 25px; background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%); color:white; border-radius:8px; box-shadow:0 5px 15px rgba(0,0,0,0.2); transform:translateX(100%); opacity:0; transition:all .5s; z-index:1000;">
        <i class="fas fa-check-circle"></i> Markdown downloaded successfully!
    </div>

    <header>
        <h1>Jobname Markdown Generator</h1>
        <p class="description">Generate markdown files with your content and jobname structure</p>
    </header>

    <div class="container">
        <div class="form-grid">
            <!-- Company Information -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-building"></i> Company Information</h2>
                <div class="compact-form">
                    <div class="form-group">
                        <label for="companyName"><i class="fas fa-signature"></i> Company Name <span class="required">*</span></label>
                        <input type="text" id="companyName" placeholder="Enter company name">
                    </div>
                    <div class="form-group">
                        <label for="companySite"><i class="fas fa-globe"></i> Company Website <span class="required">*</span></label>
                        <input type="url" id="companySite" placeholder="https://example.com">
                    </div>
                    <div class="form-group">
                        <label for="jobTitle"><i class="fas fa-briefcase"></i> Job Title <span class="required">*</span></label>
                        <select id="jobTitle">
                            <!-- options omitted for brevity in this view; same as before -->
                            <option value="Software Engineer" selected>Software Engineer</option>
                            <!-- ...other options... -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- Interview Timeline -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-calendar-alt"></i> Interview Timeline</h2>
                <div class="compact-form">
                    <div class="field-row">
                        <div class="form-group">
                            <label for="sentResume"><i class="fas fa-paper-plane"></i> Sent Resume</label>
                            <input type="text" id="sentResume" class="air-date-input" value="2023-10-30" placeholder="yyyy/mm/dd">
                        </div>
                        <div class="form-group">
                            <label for="hrCall"><i class="fas fa-phone"></i> HR Call</label>
                            <input type="text" id="hrCall" class="air-date-input" value="2023-11-07" placeholder="yyyy/mm/dd">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="form-group">
                            <label for="technicalInterview"><i class="fas fa-laptop-code"></i> Technical Interview</label>
                            <input type="text" id="technicalInterview" class="air-date-input" value="2023-11-12" placeholder="yyyy/mm/dd">
                        </div>
                    </div>

                    <div class="email-field-group">
                        <div class="form-group">
                            <label for="rejectionEmail"><i class="fas fa-envelope"></i> Rejection Email <span class="email-status-label rejection-status">Rejected</span></label>
                            <input type="text" id="rejectionEmail" class="air-date-input" placeholder="yyyy/mm/dd">
                        </div>
                        <div class="form-group">
                            <label for="offerEmail"><i class="fas fa-envelope"></i> Offer Email <span class="email-status-label offer-status">Offer</span></label>
                            <input type="text" id="offerEmail" class="air-date-input" placeholder="yyyy/mm/dd">
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Interview Duration</label>
                        <div class="time-inputs">
                            <div class="form-group">
                                <label for="hours">Hours</label>
                                <input type="number" id="hours" min="0" max="10" value="1">
                            </div>
                            <div class="form-group">
                                <label for="minutes">Minutes</label>
                                <input type="number" id="minutes" min="0" max="59" value="10">
                            </div>
                        </div>
                        <div class="duration-fix">Note: 0 hours or 0 minutes will not be displayed</div>
                    </div>
                </div>
            </div>

            <!-- Application Details -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-tasks"></i> Application Details</h2>
                <div class="compact-form">
                    <div class="form-group">
                        <label><i class="fas fa-list-alt"></i> Status <span class="required">*</span></label>
                        <div class="status-options">
                            <label class="checkbox-label"><input type="checkbox" name="status" value="📜" checked><span class="icon">📜</span> Apply Resume</label>
                            <label class="checkbox-label"><input type="checkbox" name="status" value="📞" checked><span class="icon">📞</span> HR Call</label>
                            <label class="checkbox-label"><input type="checkbox" name="status" value="🔧" checked><span class="icon">🔧</span> Technical</label>
                            <label class="checkbox-label"><input type="checkbox" name="status" value="❌" checked><span class="icon">❌</span> Rejected</label>
                            <label class="checkbox-label"><input type="checkbox" name="status" value="👱🏻‍♀️"><span class="icon">👱🏻‍♀️</span> HR Interview</label>
                            <label class="checkbox-label"><input type="checkbox" name="status" value="✅"><span class="icon">✅</span> Accepted</label>
                            <label class="checkbox-label"><input type="checkbox" name="status" value="📝"><span class="icon">📝</span> Task</label>
                            <label class="checkbox-label"><input type="checkbox" name="status" value="⚖️"><span class="icon">⚖️</span> Code Review</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-paper-plane"></i> Apply Way <span class="required">*</span></label>
                        <div class="apply-options">
                            <label class="checkbox-label"><input type="checkbox" name="applyWay" value="Site" checked><i class="fas fa-desktop"></i> Site</label>
                            <label class="checkbox-label"><input type="checkbox" name="applyWay" value="LinkedIn" checked><i class="fab fa-linkedin"></i> LinkedIn</label>
                            <label class="checkbox-label"><input type="checkbox" name="applyWay" value="Refer"><i class="fas fa-user-friends"></i> Refer</label>
                            <label class="checkbox-label"><input type="checkbox" name="applyWay" value="Jobinja"><i class="fas fa-briefcase"></i> Jobinja</label>
                            <label class="checkbox-label"><input type="checkbox" name="applyWay" value="Jobvision"><i class="fas fa-eye"></i> Jobvision</label>
                            <label class="checkbox-label"><input type="checkbox" name="applyWay" value="Quera"><i class="fas fa-code"></i> Quera</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="interviewPlatform"><i class="fas fa-video"></i> Interview Platform <span class="required">*</span></label>
                        <select id="interviewPlatform"><option value="Google Meet" selected>Google Meet</option><option value="Microsoft Teams">Microsoft Teams</option><option value="Zoom">Zoom</option><option value="In-person">In-person</option><option value="Phone">Phone</option></select>
                    </div>

                    <div class="form-group">
                        <label for="score"><i class="fas fa-star"></i> Score <span class="required">*</span></label>
                        <div class="score-input">
                            <input type="range" id="score" min="0" max="10" step="0.5" value="5">
                            <div class="score-display">5/10</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Interview Process -->
            <div class="card interview-process-card">
                <h2 class="card-title"><i class="fas fa-project-diagram"></i> Interview Process</h2>
                <div class="form-group">
                    <label for="interviewProcess"><i class="fas fa-code"></i> Mermaid Diagram Code <span class="required">*</span></label>
                    <textarea id="interviewProcess" rows="6">flowchart LR
    sr(Send Resume) --> hr(HR Call) --> ti(Technical Interview) --rejected--x hri(HR Interview) -.-> o(Offer)</textarea>
                </div>
                <div class="toggle-section">
                    <div class="toggle-header"><i class="fas fa-eye"></i><span>Preview Diagram</span></div>
                    <div class="toggle-content"><div class="mermaid-preview"><p>Mermaid diagram preview will be displayed here after rendering</p></div></div>
                </div>
            </div>

            <!-- Technical Interview Notes (Q&A Editor) -->
            <div class="card full-width">
                <h2 class="card-title"><i class="fas fa-sticky-note"></i> Technical Interview Notes</h2>
                <div class="form-group">
                    <label for="qaEditor"><i class="fas fa-edit"></i> Q&A Editor <span class="required">*</span></label>

                    <div class="qa-editor" id="qaEditor">
                        <div class="qa-controls">
                            <div style="font-size:14px; color:var(--gray)">Create question boxes and answers side-by-side. Click + to add.</div>
                            <button id="addQaBtn" class="add-qa-btn"><i class="fas fa-plus"></i> Add Q&A</button>
                        </div>

                        <div class="qa-list" id="qaList"></div>
                    </div>

                    <!-- Hidden legacy textarea (used to seed initial content) -->
                    <textarea id="legacyInterviewNotes" style="display:none">Because I'm unemployed. </textarea>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="actions">
            <button id="downloadBtn"><i class="fas fa-download"></i> Download Markdown</button>
            <button class="secondary" id="resetBtn"><i class="fas fa-redo"></i> Reset Form</button>
        </div>

        <!-- Preview -->
        <div class="preview-container">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-eye"></i> Preview</h2>
                <div class="preview" id="markdownPreview"></div>
            </div>
        </div>
    </div>

    <!-- Air Datepicker JS (jsDelivr - v3.6.0) -->
    <script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.6.0/air-datepicker.js"></script>

    <script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

mermaid.initialize({ startOnLoad: false });

// Helper to render mermaid text into a container
async function renderMermaidTo(container, text) {
  try {
    if (!container) return;
    if (!text || !text.trim()) {
      container.innerHTML = '<div style="color:#6c757d;font-style:italic">No mermaid diagram provided.</div>';
      return;
    }

    container.innerHTML = '<div style="opacity:0.7">Rendering diagram...</div>';

    const id = 'mermaid-' + Math.random().toString(36).slice(2, 9);
    const { svg, bindFunctions } = await mermaid.render(id, text);

    container.innerHTML = svg;
    if (bindFunctions) bindFunctions(container);
  } catch (err) {
    const message = (err && err.message) ? err.message : String(err);
    container.innerHTML = `<pre style="color:#c62828; white-space:pre-wrap">Mermaid render error:\n${message}</pre>`;
    console.error('Mermaid render error:', err);
  }
}

function debounce(fn, delay = 250) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), delay);
  };
}

document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const companyNameInput = document.getElementById('companyName');
    const companySiteInput = document.getElementById('companySite');
    const jobTitleSelect = document.getElementById('jobTitle');
    const interviewPlatformSelect = document.getElementById('interviewPlatform');
    const scoreInput = document.getElementById('score') || document.getElementById('score'); // safe-get
    const scoreDisplay = document.querySelector('.score-display');
    const markdownPreview = document.getElementById('markdownPreview');
    const notification = document.getElementById('notification');
    const mermaidContainer = document.querySelector('.mermaid-preview');
    const mermaidTextarea = document.getElementById('interviewProcess');
    const rejectionEmailInput = document.getElementById('rejectionEmail');
    const offerEmailInput = document.getElementById('offerEmail');

    const qaListContainer = document.getElementById('qaList');
    const addQaBtn = document.getElementById('addQaBtn');
    const legacyInterviewNotes = document.getElementById('legacyInterviewNotes');

    // Debounced mermaid renderer
    const debouncedRenderMermaid = debounce((text) => renderMermaidTo(mermaidContainer, text), 200);

    // Set default value for platform select
    if (interviewPlatformSelect) interviewPlatformSelect.value = "Google Meet";

    // QA items store
    let qaItems = [];

    function renderQAList() {
        qaListContainer.innerHTML = '';
        qaItems.forEach((item, idx) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'qa-item';

            const qta = document.createElement('textarea');
            qta.className = 'question-input';
            qta.placeholder = 'Write the question here (single line or short paragraph)';
            qta.value = item.q;
            qta.addEventListener('input', () => {
                qaItems[idx].q = qta.value;
                updatePreview();
            });

            const ata = document.createElement('textarea');
            ata.className = 'answer-input';
            ata.placeholder = 'Write the answer here (supports Markdown/HTML)';
            ata.value = item.a;
            ata.addEventListener('input', () => {
                qaItems[idx].a = ata.value;
                updatePreview();
            });

            const actions = document.createElement('div');
            actions.className = 'qa-actions';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-qa-btn';
            removeBtn.textContent = 'Delete';
            removeBtn.addEventListener('click', () => {
                removeQA(idx);
            });

            actions.appendChild(removeBtn);

            wrapper.appendChild(qta);
            wrapper.appendChild(ata);
            wrapper.appendChild(actions);

            qaListContainer.appendChild(wrapper);
        });

        // If no items, show a helpful empty state
        if (qaItems.length === 0) {
            const empty = document.createElement('div');
            empty.style.color = 'var(--gray)';
            empty.style.fontStyle = 'italic';
            empty.textContent = 'No Q&A yet. Click "Add Q&A" to create the first pair.';
            qaListContainer.appendChild(empty);
        }
    }

    function addQA(q = '', a = '') {
        qaItems.push({ q: q || '', a: a || '' });
        renderQAList();
        updatePreview();
    }

    function removeQA(index) {
        qaItems.splice(index, 1);
        renderQAList();
        updatePreview();
    }

    // Initialize QA from legacy textarea if present (best-effort parsing)
    (function seedInitialQA() {
        const raw = legacyInterviewNotes ? legacyInterviewNotes.value.trim() : '';
        if (!raw) {
            addQA();
            return;
        }

        // Try to extract a first question (line that starts with '-') and an answer block (details or the rest)
        const lines = raw.split('\n');
        let firstQuestion = '';
        let answerRemaining = '';

        // find first line starting with '- '
        for (let i = 0; i < lines.length; i++) {
            const l = lines[i].trim();
            if (l.startsWith('- ')) {
                firstQuestion = l.replace(/^-\\s*/, '');
                answerRemaining = lines.slice(i + 1).join('\n');
                break;
            }
        }

        // if no '- ' found, put all content into answer
        if (!firstQuestion) {
            addQA('Why are you applying for this job?', raw);
        } else {
            addQA(firstQuestion, answerRemaining.trim() || '');
        }
    })();

    // Wire add button
    addQaBtn.addEventListener('click', () => addQA());

    // Score handling (if score input exists)
    const scoreEl = document.getElementById('score');
    if (scoreEl) {
        scoreEl.addEventListener('input', function() {
            const val = this.value;
            if (scoreDisplay) scoreDisplay.textContent = `${val}/10`;

            const num = parseFloat(val) || 0;
            if (num >= 8) {
                scoreDisplay.style.background = 'linear-gradient(135deg, #4caf50 0%, #2e7d32 100%)';
            } else if (num >= 5) {
                scoreDisplay.style.background = 'linear-gradient(135deg, #ff9800 0%, #ef6c00 100%)';
            } else {
                scoreDisplay.style.background = 'linear-gradient(135deg, #f44336 0%, #c62828 100%)';
            }
            updatePreview();
        });
    }

    // Update preview when any field changes
    document.querySelectorAll('input, select, textarea').forEach(element => {
        element.addEventListener('input', updatePreview);
        element.addEventListener('change', updatePreview);
    });

    // Toggle sections
    const toggleHeaders = document.querySelectorAll('.toggle-header');
    toggleHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
            const icon = this.querySelector('i');
            if (icon) { icon.classList.toggle('fa-eye'); icon.classList.toggle('fa-eye-slash'); }
        });
    });

    // ----------------------------
    // Air Datepicker integration
    // ----------------------------
    function parseDateFromString(s) {
      if (!s) return null;
      s = String(s).trim();
      const sep = s.includes('-') ? '-' : s.includes('/') ? '/' : null;
      if (sep) {
        const parts = s.split(sep).map(p => p.replace(/^0+/, '') || '0');
        if (parts.length >= 3) {
          const y = parseInt(parts[0], 10);
          const m = parseInt(parts[1], 10);
          const d = parseInt(parts[2], 10);
          if (!Number.isNaN(y) && !Number.isNaN(m) && !Number.isNaN(d)) {
            return new Date(y, m - 1, d);
          }
        }
      }
      const dd = new Date(s);
      return isNaN(dd) ? null : dd;
    }

    const dateIds = ['sentResume', 'hrCall', 'technicalInterview', 'rejectionEmail', 'offerEmail'];
    const enLocale = {
      days: ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],
      daysShort: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
      daysMin: ['Su','Mo','Tu','We','Th','Fr','Sa'],
      months: ['January','February','March','April','May','June','July','August','September','October','November','December'],
      monthsShort: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
      today: 'Today', clear: 'Clear', dateFormat: 'yyyy/MM/dd', timeFormat: 'hh:mm', firstDay: 1
    };

    dateIds.forEach(id => {
      const input = document.getElementById(id);
      if (!input) return;
      const parsed = parseDateFromString(input.value);
      new AirDatepicker(`#${id}`, {
        locale: enLocale,
        dateFormat: 'yyyy/MM/dd',
        selectedDates: parsed ? [parsed] : [],
        autoClose: true,
        onSelect: function() {
          input.dispatchEvent(new Event('input', { bubbles: true }));
          input.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
      input.placeholder = 'yyyy/mm/dd';
    });

    // Download button
    document.getElementById('downloadBtn').addEventListener('click', function() {
        const markdownContent = generateMarkdown();
        const blob = new Blob([markdownContent], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const rawName = (companyNameInput && companyNameInput.value || '').trim();
        const slug = rawName ? rawName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '') : 'company';
        a.download = `${slug}-interview.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification('Markdown downloaded successfully!');
    });

    // Reset button
    document.getElementById('resetBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all fields?')) {
            document.querySelectorAll('input, textarea, select').forEach(element => {
                if (element.type !== 'button') element.value = element.defaultValue;
            });
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = checkbox.defaultChecked);
            document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = radio.defaultChecked);
            if (jobTitleSelect) jobTitleSelect.value = "Software Engineer";
            if (interviewPlatformSelect) interviewPlatformSelect.value = "Google Meet";

            // reset QA items
            qaItems = [];
            (function seedAgain(){
                const raw = legacyInterviewNotes ? legacyInterviewNotes.value.trim() : '';
                if (!raw) { addQA(); return; }
                const lines = raw.split('\n');
                let firstQuestion = '';
                let answerRemaining = '';
                for (let i = 0; i < lines.length; i++) {
                    const l = lines[i].trim();
                    if (l.startsWith('- ')) {
                        firstQuestion = l.replace(/^-\\s*/, '');
                        answerRemaining = lines.slice(i + 1).join('\n');
                        break;
                    }
                }
                if (!firstQuestion) { addQA('Question 1', raw); } else { addQA(firstQuestion, answerRemaining.trim() || ''); }
            })();

            updatePreview();
            this.innerHTML = '<i class="fas fa-check-circle"></i> Reset';
            setTimeout(() => { this.innerHTML = '<i class="fas fa-redo"></i> Reset Form'; }, 2000);
        }
    });

    // Helpers
    function formatDuration(hours, minutes) {
        hours = parseInt(hours) || 0; minutes = parseInt(minutes) || 0;
        if (hours === 0 && minutes === 0) return "Duration not specified";
        let parts = []; if (hours > 0) parts.push(`${hours} hour${hours !== 1 ? 's' : ''}`); if (minutes > 0) parts.push(`${minutes} minute${minutes !== 1 ? 's' : ''}`);
        return parts.join(' & ');
    }

    function formatDate(dateString) {
        if (!dateString) return 'Date not set';
        if (dateString instanceof Date) {
            const date = dateString;
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2,'0')}/${String(date.getDate()).padStart(2,'0')}`;
        }
        const parsed = parseDateFromString(dateString);
        if (!parsed) return 'Date not set';
        return `${parsed.getFullYear()}/${String(parsed.getMonth() + 1).padStart(2,'0')}/${String(parsed.getDate()).padStart(2,'0')}`;
    }

    function generateMarkdown() {
        const companyName = (companyNameInput && companyNameInput.value) || '';
        const companySite = (companySiteInput && companySiteInput.value) || '';
        const jobTitle = (jobTitleSelect && jobTitleSelect.value) || '';

        const statusValues = Array.from(document.querySelectorAll('input[name="status"]:checked')).map(cb=>cb.value).join('');
        const applyWayValues = Array.from(document.querySelectorAll('input[name="applyWay"]:checked')).map(cb=>cb.value).join(' & ');

        const interviewProcess = mermaidTextarea ? mermaidTextarea.value : '';
        const sentResume = document.getElementById('sentResume') ? document.getElementById('sentResume').value : '';
        const hrCall = document.getElementById('hrCall') ? document.getElementById('hrCall').value : '';
        const technicalInterview = document.getElementById('technicalInterview') ? document.getElementById('technicalInterview').value : '';
        const rejectionEmail = document.getElementById('rejectionEmail') ? document.getElementById('rejectionEmail').value : '';
        const offerEmail = document.getElementById('offerEmail') ? document.getElementById('offerEmail').value : '';
        const hours = document.getElementById('hours') ? document.getElementById('hours').value : 0;
        const minutes = document.getElementById('minutes') ? document.getElementById('minutes').value : 0;
        const interviewPlatform = interviewPlatformSelect ? interviewPlatformSelect.value : '';
        const score = document.getElementById('score') ? document.getElementById('score').value : '0';

        const duration = formatDuration(hours, minutes);

        let emailLine = '';
        if (rejectionEmail) emailLine = `- **Rejection Email**<br />${formatDate(rejectionEmail)}`;
        else if (offerEmail) emailLine = `- **Offer Email**<br />${formatDate(offerEmail)}`;
        else emailLine = `- **Response Email**<br />Date not set`;

        const scoreNum = parseFloat(score) || 0;
        let scoreColor = '#4caf50';
        if (scoreNum >= 8) scoreColor = '#4caf50';
        else if (scoreNum >= 5) scoreColor = '#ff9800';
        else scoreColor = '#f44336';
        const scoreHtml = `<mark style="background-color:${scoreColor}; color:#ffffff; padding:4px 8px; border-radius:4px">${scoreNum}/10</mark>`;

        const qaMarkdown = qaItems.map(item => {
    const q = (item.q || '').trim() || 'Question';
    const a = (item.a || '').trim() || 'Answer not provided';

    return `- ${q}
    <details>
    <summary style="font-size:14px"><b><em>Answer</em></b></summary>
    <div style="border:2px dashed #4a5568; padding:12px; border-radius:6px; margin-top:8px;  background-color: rgba(74,85,104,0.15);">

    ${a}

    </div>
    </details>`;
}).join('\n\n');


        return `# [${companyName}](${companySite})\n\n### Status\n#### ${statusValues}\n\n## ${jobTitle}\n\n### Interview Process\n\`\`\`mermaid\n${interviewProcess}\n\`\`\`\n\n### Apply Way\n${applyWayValues}\n\n### Interview Date\n\n- **Sent Resume**<br />${formatDate(sentResume)}\n\n- **HR Call**<br />${formatDate(hrCall)}\n\n- **Technical Interview**<br />${formatDate(technicalInterview)}\n\n${emailLine}\n\n### Interview Duration\n- **Technical Interview**<br />${duration}\n\n### Interview Platform\n${interviewPlatform}\n\n### Technical Interview\n${qaMarkdown}\n\n## Score\n<h4>${scoreHtml}</h4>`;
    }

    function updatePreview() {
        markdownPreview.textContent = generateMarkdown();
        if (mermaidContainer) {
            const text = mermaidTextarea ? mermaidTextarea.value : '';
            debouncedRenderMermaid(text);
        }
    }

    function showNotification(message) {
        if (!notification) return;
        notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        notification.classList.add('show');
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
        setTimeout(() => {
            notification.classList.remove('show');
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
        }, 3000);
    }

    // Initialize
    renderQAList();
    const scoreInit = document.getElementById('score');
    if (scoreInit) scoreInit.dispatchEvent(new Event('input'));
    updatePreview();
});
    </script>
</body>
</html>

