<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobname Markdown Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Source+Code+Pro:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">

    <!-- Air Datepicker CSS (jsDelivr - v3.6.0) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/air-datepicker@3.6.0/air-datepicker.css">

    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --card-bg: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Fira Sans', 'Ubuntu Mono', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark);
            background: linear-gradient(135deg, #f5f7fb 0%, #e4e8f0 100%);
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 992px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 60%);
            transform: rotate(30deg);
        }
        
        h1 {
            font-size: 2.4rem;
            margin-bottom: 10px;
            position: relative;
            font-weight: bold;
        }
        
        .description {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 700px;
            margin: 0 auto;
            position: relative;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        input[type="text"],
        input[type="url"],
        input[type="date"],
        input[type="number"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background-color: var(--light);
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
            background-color: #fff;
        }
        
        .checkbox-group,
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        
        .checkbox-label,
        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 14px;
            background-color: var(--light);
            border-radius: 8px;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
            font-size: 14px;
        }
        
        .checkbox-label:hover,
        .radio-label:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
        }
        
        input[type="checkbox"],
        input[type="radio"] {
            width: 18px;
            height: 18px;
        }
        
        .required {
            color: var(--warning);
        }
        
        button {
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--shadow);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        button.secondary {
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border);
        }
        
        button.secondary:hover {
            background: #e2e6ea;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
            justify-content: center;
        }
        
        .preview-container {
            width: 100%;
            margin-top: 20px;
        }
        
        .preview {
            white-space: pre-wrap;
            background-color: var(--light);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: 'Courier New', Courier, monospace;
            line-height: 1.5;
            transition: all 0.3s;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            font-size: 14px;
        }
        
        .preview:hover {
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
        }
        
        .field-row {
            display: flex;
            gap: 15px;
        }
        
        .field-row .form-group {
            flex: 1;
        }
        
        .score-input {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .score-input input {
            width: 100px;
            flex-shrink: 0;
        }
        
        .score-display {
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 20px;
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
            min-width: 80px;
            text-align: center;
        }
        
        .toggle-section {
            margin-top: 15px;
        }
        
        .toggle-header {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            background-color: var(--light);
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .toggle-header:hover {
            background-color: #e9ecef;
        }
        
        .toggle-content {
            padding: 15px;
            background-color: var(--light);
            border-radius: 0 0 8px 8px;
            margin-top: -5px;
            border: 1px solid var(--border);
            border-top: none;
            display: block; /* Changed from none to block by default */
        }
        
        .icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        
        .success-badge {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .time-inputs {
            display: flex;
            gap: 15px;
        }
        
        .time-inputs .form-group {
            flex: 1;
        }
        
        /* IMPROVED MERMAID PREVIEW SECTION */
        .mermaid-preview {
            margin-top: 15px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid var(--border);
            min-height: 250px; /* Increased from 150px */
            height: 350px; /* Added fixed height */
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray);
            font-style: italic;
            font-size: 14px;
            overflow: auto; /* Added for scroll if needed */
            resize: vertical; /* Allow user to resize if needed */
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.5s;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .compact-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .status-options, .apply-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 8px;
        }
        
        .duration-fix {
            font-size: 14px;
            color: var(--gray);
            margin-top: 5px;
        }
        
        /* New styles for better layout */
        .interview-process-card {
            display: flex;
            flex-direction: column;
            height: 100%; /* Make card take full height */
        }
        
        .interview-process-card .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .interview-process-card textarea {
            flex: 1; /* Make textarea take available space */
            min-height: 150px;
            resize: vertical; /* Allow vertical resize */
        }
        
        .toggle-section {
            flex: 2; /* Give more space to diagram preview */
            display: flex;
            flex-direction: column;
        }
        
        .toggle-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Small tweak for the date inputs when using Air Datepicker */
        .air-date-input {
            position: relative;
        }
        
        /* New styles for email fields */
        .email-field-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .email-field-group .form-group {
            flex: 1;
            position: relative;
        }
        
        .email-field-group .form-group::after {
            content: "OR";
            position: absolute;
            top: 50%;
            right: -25px;
            transform: translateY(-50%);
            background: var(--light);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: var(--gray);
            z-index: 1;
        }
        
        .email-field-group .form-group:last-child::after {
            display: none;
        }
        
        .email-status-label {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .rejection-status {
            background-color: #ffe6e6;
            color: #d32f2f;
        }
        
        .offer-status {
            background-color: #e6f7e6;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i> Markdown downloaded successfully!
    </div>
    
    <header>
        <h1>Jobname Markdown Generator</h1>
        <p class="description">Generate markdown files with your content and jobname structure</p>
    </header>
    
    <div class="container">
        <div class="form-grid">
            <!-- Company Information -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-building"></i> Company Information</h2>
                
                <div class="compact-form">
                    <div class="form-group">
                        <label for="companyName"><i class="fas fa-signature"></i> Company Name <span class="required">*</span></label>
                        <input type="text" id="companyName"  placeholder="Enter company name">
                    </div>
                    
                    <div class="form-group">
                        <label for="companySite"><i class="fas fa-globe"></i> Company Website <span class="required">*</span></label>
                        <input type="url" id="companySite" placeholder="https://example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="jobTitle"><i class="fas fa-briefcase"></i> Job Title <span class="required">*</span></label>
                        <select id="jobTitle">
                            <option value="Director of Engineering">Director of Engineering</option>
                            <option value="Engineering Manager">Engineering Manager</option>
                            <option value="Technical Lead">Technical Lead</option>
                            <option value="Team Lead">Team Lead</option>
                            <option value="Senior Software Engineer">Senior Software Engineer</option>
                            <option value="Software Engineer" selected>Software Engineer</option>
                            <option value="Junior Software Engineer">Junior Software Engineer</option>
                            <option value="Software Developer">Software Developer</option>
                            <option value="Junior Software Developer">Junior Software Developer</option>
                            <option value="Intern Software Developer">Intern Software Developer</option>
                            <option value="AI Software Engineer">AI Software Engineer</option>
                            <option value="Back-End Developer">Back-End Developer</option>
                            <option value="Back-End Engineer">Back-End Engineer</option>
                            <option value="Front-End Developer">Front-End Developer</option>
                            <option value="Front-End Engineer">Front-End Engineer</option>
                            <option value="Full-Stack Developer">Full-Stack Developer</option>
                            <option value="Python Developer">Python Developer</option>
                            <option value="Senior Python Developer">Senior Python Developer</option>
                            <option value="Go Developer">Go Developer</option>
                            <option value="Golang Developer">Golang Developer</option>
                            <option value="Senior Golang Developer">Senior Golang Developer</option>
                            <option value="Senior Go Developer">Senior Go Developer</option>
                            <option value="Mobile Developer">Mobile Developer</option>
                            <option value="Android Developer">Android Developer</option>
                            <option value="Game Developer">Game Developer</option>
                            <option value="Systems Engineer">Systems Engineer</option>
                            <option value="Systems Administrator">Systems Administrator</option>
                            <option value="Machine Learning Engineer">Machine Learning Engineer</option>
                            <option value="Database Administrator">Database Administrator</option>
                            <option value="Data Analyst">Data Analyst</option>
                            <option value="Data Scientist">Data Scientist</option>
                            <option value="Data Engineer">Data Engineer</option>
                            <option value="Blockchain Developer">Blockchain Developer</option>
                            <option value="Java Developer">Java Developer</option>
                            <option value="Site Reliability Engineer (SRE)">Site Reliability Engineer (SRE)</option>
                            <option value="Web Developer">Web Developer</option>
                            <option value="Computer Systems Analyst">Computer Systems Analyst</option>
                            <option value="Cloud Engineer">Cloud Engineer</option>
                            <option value="DevOps Engineer">DevOps Engineer</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Interview Timeline -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-calendar-alt"></i> Interview Timeline</h2>
                
                <div class="compact-form">
                    <div class="field-row">
                        <div class="form-group">
                            <label for="sentResume"><i class="fas fa-paper-plane"></i> Sent Resume</label>
                            <!-- changed to text input to allow Air Datepicker -->
                            <input type="text" id="sentResume" class="air-date-input" value="2023-10-30" placeholder="yyyy/mm/dd">
                        </div>
                        
                        <div class="form-group">
                            <label for="hrCall"><i class="fas fa-phone"></i> HR Call</label>
                            <input type="text" id="hrCall" class="air-date-input" value="2023-11-07" placeholder="yyyy/mm/dd">
                        </div>
                    </div>
                    
                    <div class="field-row">
                        <div class="form-group">
                            <label for="technicalInterview"><i class="fas fa-laptop-code"></i> Technical Interview</label>
                            <input type="text" id="technicalInterview" class="air-date-input" value="2023-11-12" placeholder="yyyy/mm/dd">
                        </div>
                    </div>
                    
                    <!-- Email fields grouped together with OR indicator -->
                    <div class="email-field-group">
                        <div class="form-group">
                            <label for="rejectionEmail"><i class="fas fa-envelope"></i> Rejection Email 
                                <span class="email-status-label rejection-status">Rejected</span>
                            </label>
                            <input type="text" id="rejectionEmail" class="air-date-input" placeholder="yyyy/mm/dd">
                        </div>
                        
                        <div class="form-group">
                            <label for="offerEmail"><i class="fas fa-envelope"></i> Offer Email 
                                <span class="email-status-label offer-status">Offer</span>
                            </label>
                            <input type="text" id="offerEmail" class="air-date-input" placeholder="yyyy/mm/dd">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Interview Duration</label>
                        <div class="time-inputs">
                            <div class="form-group">
                                <label for="hours">Hours</label>
                                <input type="number" id="hours" min="0" max="10" value="1">
                            </div>
                            <div class="form-group">
                                <label for="minutes">Minutes</label>
                                <input type="number" id="minutes" min="0" max="59" value="10">
                            </div>
                        </div>
                        <div class="duration-fix">Note: 0 hours or 0 minutes will not be displayed</div>
                    </div>
                </div>
            </div>
            
            <!-- Application Details -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-tasks"></i> Application Details</h2>
                
                <div class="compact-form">
                    <div class="form-group">
                        <label><i class="fas fa-list-alt"></i> Status <span class="required">*</span></label>
                        <div class="status-options">
                            <label class="checkbox-label">
                                <input type="checkbox" name="status" value="üìú" checked>
                                <span class="icon">üìú</span> Apply Resume
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="status" value="üìû" checked>
                                <span class="icon">üìû</span> HR Call
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="status" value="üîß" checked>
                                <span class="icon">üîß</span> Technical
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="status" value="‚ùå" checked>
                                <span class="icon">‚ùå</span> Rejected
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="status" value="üë±üèª‚Äç‚ôÄÔ∏è">
                                <span class="icon">üë±üèª‚Äç‚ôÄÔ∏è</span> HR Interview
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="status" value="‚úÖ">
                                <span class="icon">‚úÖ</span> Accepted
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="status" value="üìù">
                                <span class="icon">üìù</span> Task
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="status" value="‚öñÔ∏è">
                                <span class="icon">‚öñÔ∏è</span> Code Review
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-paper-plane"></i> Apply Way <span class="required">*</span></label>
                        <div class="apply-options">
                            <label class="checkbox-label">
                                <input type="checkbox" name="applyWay" value="Site" checked>
                                <i class="fas fa-desktop"></i> Site
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="applyWay" value="LinkedIn" checked>
                                <i class="fab fa-linkedin"></i> LinkedIn
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="applyWay" value="Refer">
                                <i class="fas fa-user-friends"></i> Refer
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="applyWay" value="Jobinja">
                                <i class="fas fa-briefcase"></i> Jobinja
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="applyWay" value="Jobvision">
                                <i class="fas fa-eye"></i> Jobvision
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="applyWay" value="Quera">
                                <i class="fas fa-code"></i> Quera
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="interviewPlatform"><i class="fas fa-video"></i> Interview Platform <span class="required">*</span></label>
                        <select id="interviewPlatform">
                            <option value="Google Meet" selected>Google Meet</option>
                            <option value="Microsoft Teams">Microsoft Teams</option>
                            <option value="Zoom">Zoom</option>
                            <option value="In-person">In-person</option>
                            <option value="Phone">Phone</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="score"><i class="fas fa-star"></i> Score <span class="required">*</span></label>
                        <div class="score-input">
                            <input type="range" id="score" min="0" max="10" step="0.5" value="5">
                            <div class="score-display">5/10</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Interview Process - Improved with better height management -->
            <div class="card interview-process-card">
                <h2 class="card-title"><i class="fas fa-project-diagram"></i> Interview Process</h2>
                
                <div class="form-group">
                    <label for="interviewProcess"><i class="fas fa-code"></i> Mermaid Diagram Code <span class="required">*</span></label>
                    <textarea id="interviewProcess" rows="6">flowchart LR
    sr(Send Resume) --> hr(HR Call) --> ti(Technical Interview) --rejected--x hri(HR Interview) -.-> o(Offer)</textarea>
                </div>
                
                <div class="toggle-section">
                    <div class="toggle-header">
                        <i class="fas fa-eye"></i>
                        <span>Preview Diagram</span>
                    </div>
                    <div class="toggle-content">
                        <div class="mermaid-preview">
                            <p>Mermaid diagram preview will be displayed here after rendering</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Technical Interview Notes (Full Width) -->
            <div class="card full-width">
                <h2 class="card-title"><i class="fas fa-sticky-note"></i> Technical Interview Notes</h2>
                
                <div class="form-group">
                    <label for="interviewNotes"><i class="fas fa-edit"></i> Notes <span class="required">*</span></label>
                    <textarea id="interviewNotes" rows="8">- Tell us about yourself.

- Whould you like to work free?

- Do you think we are family (HR said)?

... 

- Any question?</textarea>
                </div>
            </div>
        </div>
        
        <!-- Buttons -->
        <div class="actions">
            <button id="downloadBtn">
                <i class="fas fa-download"></i> Download Markdown
            </button>
            <button class="secondary" id="resetBtn">
                <i class="fas fa-redo"></i> Reset Form
            </button>
        </div>
        
        <!-- Preview -->
        <div class="preview-container">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-eye"></i> Preview</h2>
                <div class="preview" id="markdownPreview">
                    <!-- Preview content will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Air Datepicker JS (jsDelivr - v3.6.0) -->
    <script src="https://cdn.jsdelivr.net/npm/air-datepicker@3.6.0/air-datepicker.js"></script>

    <script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

mermaid.initialize({ startOnLoad: false });

// Helper to render mermaid text into a container
async function renderMermaidTo(container, text) {
  try {
    if (!container) return;
    if (!text || !text.trim()) {
      container.innerHTML = '<div style="color:#6c757d;font-style:italic">No mermaid diagram provided.</div>';
      return;
    }

    container.innerHTML = '<div style="opacity:0.7">Rendering diagram...</div>';

    const id = 'mermaid-' + Math.random().toString(36).slice(2, 9);
    const { svg, bindFunctions } = await mermaid.render(id, text);

    container.innerHTML = svg;
    if (bindFunctions) bindFunctions(container);
  } catch (err) {
    const message = (err && err.message) ? err.message : String(err);
    container.innerHTML = `<pre style="color:#c62828; white-space:pre-wrap">Mermaid render error:\n${message}</pre>`;
    console.error('Mermaid render error:', err);
  }
}

function debounce(fn, delay = 250) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), delay);
  };
}

document.addEventListener('DOMContentLoaded', function() {
    // DOM elements
    const companyNameInput = document.getElementById('companyName');
    const companySiteInput = document.getElementById('companySite');
    const jobTitleSelect = document.getElementById('jobTitle');
    const interviewPlatformSelect = document.getElementById('interviewPlatform');
    const scoreInput = document.getElementById('score');
    const scoreDisplay = document.querySelector('.score-display');
    const markdownPreview = document.getElementById('markdownPreview');
    const notification = document.getElementById('notification');
    const mermaidContainer = document.querySelector('.mermaid-preview');
    const mermaidTextarea = document.getElementById('interviewProcess');
    const rejectionEmailInput = document.getElementById('rejectionEmail');
    const offerEmailInput = document.getElementById('offerEmail');

    // Debounced mermaid renderer
    const debouncedRenderMermaid = debounce((text) => renderMermaidTo(mermaidContainer, text), 200);

    // Set default value for platform select
    interviewPlatformSelect.value = "Google Meet";

    // Update score display when value changes
    scoreInput.addEventListener('input', function() {
        scoreDisplay.textContent = `${this.value}/10`;

        // Change color based on score
        if (this.value >= 8) {
            scoreDisplay.style.background = 'linear-gradient(135deg, #4caf50 0%, #2e7d32 100%)';
        } else if (this.value >= 5) {
            scoreDisplay.style.background = 'linear-gradient(135deg, #ff9800 0%, #ef6c00 100%)';
        } else {
            scoreDisplay.style.background = 'linear-gradient(135deg, #f44336 0%, #c62828 100%)';
        }

        updatePreview();
    });

    // Update preview when any field changes
    document.querySelectorAll('input, select, textarea').forEach(element => {
        element.addEventListener('input', updatePreview);
        element.addEventListener('change', updatePreview);
    });

    // Toggle sections
    const toggleHeaders = document.querySelectorAll('.toggle-header');
    toggleHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const content = this.nextElementSibling;
            content.style.display = content.style.display === 'none' ? 'block' : 'none';

            // Rotate icon
            const icon = this.querySelector('i');
            if (icon) {
                // toggle between eye and eye-slash classes
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            }
        });
    });

    // ----------------------------
    // Air Datepicker integration
    // ----------------------------

    // Helper: parse 'yyyy-mm-dd' or 'yyyy/mm/dd' or Date-like strings to a Date object.
    function parseDateFromString(s) {
      if (!s) return null;
      // Trim
      s = String(s).trim();
      // Accept ISO-like 'yyyy-mm-dd' or 'yyyy/mm/dd'
      const sep = s.includes('-') ? '-' : s.includes('/') ? '/' : null;
      if (sep) {
        const parts = s.split(sep).map(p => p.replace(/^0+/, '') || '0');
        if (parts.length >= 3) {
          const y = parseInt(parts[0], 10);
          const m = parseInt(parts[1], 10);
          const d = parseInt(parts[2], 10);
          if (!Number.isNaN(y) && !Number.isNaN(m) && !Number.isNaN(d)) {
            return new Date(y, m - 1, d);
          }
        }
      }
      // fallback to Date parser
      const dd = new Date(s);
      return isNaN(dd) ? null : dd;
    }

    // Initialize Air Datepicker on specific inputs and ensure format yyyy/MM/dd (note uppercase MM)
    const dateIds = ['sentResume', 'hrCall', 'technicalInterview', 'rejectionEmail', 'offerEmail'];

    // Explicit English locale (forces English regardless of browser locale)
    const enLocale = {
      days: ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'],
      daysShort: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
      daysMin: ['Su','Mo','Tu','We','Th','Fr','Sa'],
      months: ['January','February','March','April','May','June','July','August','September','October','November','December'],
      monthsShort: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
      today: 'Today',
      clear: 'Clear',
      dateFormat: 'yyyy/MM/dd',
      timeFormat: 'hh:mm',
      firstDay: 1
    };

    dateIds.forEach(id => {
      const input = document.getElementById(id);
      if (!input) return;

      // parse the existing value into Date if possible
      const parsed = parseDateFromString(input.value);

      // Initialize Air Datepicker (dateFormat uses UTS tokens: 'yyyy/MM/dd' -> 2023/10/30)
      // See Air Datepicker docs for dateFormat tokens.
      // We also trigger input/change events after selection so your preview updates reliably.
      new AirDatepicker(`#${id}`, {
        locale: enLocale,
        dateFormat: 'yyyy/MM/dd',
        selectedDates: parsed ? [parsed] : [],
        autoClose: true,
        // onSelect will be called when a user picks a date; fire events so updatePreview runs
        onSelect: function() {
          input.dispatchEvent(new Event('input', { bubbles: true }));
          input.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });

      // give a helpful placeholder
      input.placeholder = 'yyyy/mm/dd';
    });

    // Download button functionality
    document.getElementById('downloadBtn').addEventListener('click', function() {
        const markdownContent = generateMarkdown();
        const blob = new Blob([markdownContent], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `${companyNameInput.value.toLowerCase()}-interview.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Show notification
        showNotification('Markdown downloaded successfully!');
    });

    // Reset button functionality
    document.getElementById('resetBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to reset all fields?')) {
            // Reset all input fields
            document.querySelectorAll('input, textarea, select').forEach(element => {
                if (element.type !== 'button') {
                    element.value = element.defaultValue;
                }
            });

            // Reset checkboxes and radios
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = checkbox.defaultChecked;
            });

            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = radio.defaultChecked;
            });

            // Reset select elements to their defaults
            jobTitleSelect.value = "Software Engineer";
            interviewPlatformSelect.value = "Google Meet";

            // Update preview
            updatePreview();

            // Show success indicator
            this.innerHTML = '<i class="fas fa-check-circle"></i> Reset';

            // Revert after 2 seconds
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-redo"></i> Reset Form';
            }, 2000);
        }
    });

    // Format duration correctly
    function formatDuration(hours, minutes) {
        hours = parseInt(hours) || 0;
        minutes = parseInt(minutes) || 0;

        if (hours === 0 && minutes === 0) {
            return "Duration not specified";
        }

        let parts = [];
        if (hours > 0) {
            parts.push(`${hours} hour${hours !== 1 ? 's' : ''}`);
        }
        if (minutes > 0) {
            parts.push(`${minutes} minute${minutes !== 1 ? 's' : ''}`);
        }

        return parts.join(' & ');
    }

    // Generate markdown content
    function generateMarkdown() {
        const companyName = companyNameInput.value;
        const companySite = companySiteInput.value;
        const jobTitle = jobTitleSelect.value;

        // Get status values
        const statusValues = Array.from(document.querySelectorAll('input[name="status"]:checked'))
            .map(checkbox => checkbox.value)
            .join('');

        // Get apply way values
        const applyWayValues = Array.from(document.querySelectorAll('input[name="applyWay"]:checked'))
            .map(checkbox => checkbox.value)
            .join(' & ');

        const interviewProcess = mermaidTextarea ? mermaidTextarea.value : '';
        const sentResume = document.getElementById('sentResume').value;
        const hrCall = document.getElementById('hrCall').value;
        const technicalInterview = document.getElementById('technicalInterview').value;
        const rejectionEmail = document.getElementById('rejectionEmail').value;
        const offerEmail = document.getElementById('offerEmail').value;
        const hours = document.getElementById('hours').value;
        const minutes = document.getElementById('minutes').value;
        const interviewPlatform = interviewPlatformSelect.value;
        const interviewNotes = document.getElementById('interviewNotes').value;
        const score = scoreInput.value;

        // Format duration correctly
        const duration = formatDuration(hours, minutes);

        // Determine which email date to show (rejection takes priority)
        let emailLine = '';
        if (rejectionEmail) {
            emailLine = `- **Rejection Email**<br />${formatDate(rejectionEmail)}`;
        } else if (offerEmail) {
            emailLine = `- **Offer Email**<br />${formatDate(offerEmail)}`;
        } else {
            emailLine = `- **Response Email**<br />Date not set`;
        }

        return `# [${companyName}](${companySite})

### Status
#### ${statusValues}

## ${jobTitle}

### Interview Process
\`\`\`mermaid
${interviewProcess}
\`\`\`

### Apply Way
${applyWayValues}

### Interview Date
- **Sent Resume**<br />${formatDate(sentResume)}
- **HR Call**<br />${formatDate(hrCall)}
- **Technical Interview**<br />${formatDate(technicalInterview)}
${emailLine}

### Interview Duration
- **Technical Interview**<br />${duration}

### Interview Platform
${interviewPlatform}

### Technical Interview
${interviewNotes}

## Score
<h4><mark style="background-color:#54ca56">${score}/10</mark></h4>`;
    }

    // Format date to YYYY/MM/DD format (robust: accepts yyyy-mm-dd, yyyy/mm/dd, or Date objects)
    function formatDate(dateString) {
        if (!dateString) return 'Date not set';

        // If it's already a Date, format it
        if (dateString instanceof Date) {
            const date = dateString;
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }

        // Try to parse using our parser (handles yyyy-mm-dd or yyyy/mm/dd)
        const parsed = parseDateFromString(dateString);
        if (!parsed) return 'Date not set';

        return `${parsed.getFullYear()}/${String(parsed.getMonth() + 1).padStart(2, '0')}/${String(parsed.getDate()).padStart(2, '0')}`;
    }

    // Update preview
    function updatePreview() {
        markdownPreview.textContent = generateMarkdown();

        // Render mermaid in preview area (debounced)
        if (mermaidContainer) {
            const text = mermaidTextarea ? mermaidTextarea.value : '';
            debouncedRenderMermaid(text);
        }
    }

    // Show notification
    function showNotification(message) {
        notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // Initialize
    scoreInput.dispatchEvent(new Event('input'));
    updatePreview();
});
</script>

</body>
</html>
